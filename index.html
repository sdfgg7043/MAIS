<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… â€“ Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ¬</title>
  <link rel="icon" type="image/png" href="apple-touch-icon.png" sizes="32*32">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #1e3c72;
      --secondary-color: #2a5298;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Naskh Arabic', serif;
    }
    body {
      background: #f5f5f5;
      padding: 15px;
      font-size: 13px;
      color: #333;
    }
    .invoice-container {
      width: 21cm;
      min-height: 29.7cm;
      background: white;
      margin: 0 auto;
      padding: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 120px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-color);
    }
    .logo-container {
      flex: 1;
      text-align: right;
    }
    .logo-container img {
      max-width: 130px;
    }
    .company-info {
      text-align: left;
      flex: 1;
    }
    .company-name-ar {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 2px;
    }
    .company-subtitle-ar {
      font-size: 13px;
      color: #333;
      margin-bottom: 2px;
    }
    .company-name-en {
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }
    .invoice-meta {
      text-align: center;
      flex: 1;
    }
    .payment-type {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      display: inline-block;
    }
    .payment-type.cash {
      color: var(--success-color);
      background-color: rgba(40, 167, 69, 0.1);
    }
    .payment-type.credit {
      color: var(--warning-color);
      background-color: rgba(255, 193, 7, 0.1);
    }
    .payment-type.bank {
      color: var(--info-color);
      background-color: rgba(23, 162, 184, 0.1);
    }
    .payment-type.card {
      color: var(--primary-color);
      background-color: rgba(30, 60, 114, 0.1);
    }
    .payment-type.check {
      color: var(--secondary-color);
      background-color: rgba(42, 82, 152, 0.1);
    }
    .payment-type.mixed {
      color: var(--danger-color);
      background-color: rgba(220, 53, 69, 0.1);
    }
    .invoice-status {
      font-size: 11px;
      font-weight: 600;
      margin-top: 4px;
      padding: 2px 6px;
      border-radius: 12px;
      display: inline-block;
    }
    .invoice-status.paid {
      color: var(--success-color);
      background-color: rgba(40, 167, 69, 0.1);
    }
    .invoice-status.partial {
      color: var(--warning-color);
      background-color: rgba(255, 193, 7, 0.1);
    }
    .invoice-status.unpaid {
      color: var(--danger-color);
      background-color: rgba(220, 53, 69, 0.1);
    }
    .invoice-number {
      font-size: 11px;
      color: #333;
    }
    .form-section {
      margin-bottom: 8px;
    }
    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 6px;
      background: var(--light-color);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-bottom: 6px;
    }
    .form-field {
      display: flex;
      align-items: center;
    }
    .full-width-field {
      grid-column: 1 / -1;
    }
    .form-label {
      font-weight: 600;
      min-width: 90px;
      margin-left: 6px;
      font-size: 12px;
      color: #333;
    }
    .form-input, .form-select {
      flex: 1;
      border: none;
      border-bottom: 1px solid #ddd;
      padding: 5px 6px;
      font-size: 14px;
      background: transparent;
      font-weight: 600;
      color: #222;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-bottom: 1px solid var(--primary-color);
    }
    .numeric-input {
      font-family: 'Noto Naskh Arabic', serif !important;
      font-weight: 700;
      color: #222;
    }
    .invoice-table-container {
      max-height: 300px;
      overflow-y: auto;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .invoice-table th {
      background: var(--primary-color);
      color: white;
      padding: 4px 6px;
      text-align: center;
      font-weight: 600;
      border: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .invoice-table td {
      padding: 4px 6px;
      border: 1px solid #ddd;
      text-align: center;
    }
    .col-no { width: 30px; }
    .col-details { text-align: right; min-width: 200px; }
    .col-price { width: 90px; }
    .table-input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 13px;
      padding: 4px;
      font-weight: 600;
      color: #222;
    }
    .table-input:focus {
      outline: 2px solid var(--primary-color);
      background: white;
    }
    .net-amount-section {
      background: #f0f7ff;
      border-radius: 6px;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #d0e3ff;
      text-align: center;
    }
    .net-amount-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 3px;
    }
    .net-amount-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-color);
    }
    .amount-words-section {
      background: #f9f9f9;
      border-radius: 6px;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #eee;
    }
    .amount-words-label {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      margin-bottom: 3px;
    }
    .amount-words {
      font-size: 12px;
      line-height: 1.3;
      color: #333;
    }
    .financial-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 8px 0;
    }
    .summary-card {
      background: var(--light-color);
      border-radius: 6px;
      padding: 8px;
      border-right: 3px solid var(--primary-color);
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed #ddd;
      font-size: 12px;
    }
    .summary-row:last-child {
      border-bottom: none;
    }
    .summary-label {
      font-weight: 600;
      color: #333;
    }
    .summary-value {
      font-weight: 700;
      color: var(--primary-color);
    }
    .summary-input, .print-only {
      display: inline-block !important;
      width: 120px;
      border: 1px solid #ddd;
      padding: 3px 5px;
      font-size: 12px;
      font-weight: 700;
      color: #222;
      text-align: left;
      border-radius: 4px;
      background: white;
    }
    .summary-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(30, 60, 114, 0.2);
    }
    @media print {
      .summary-input { display: none !important; }
      .print-only { display: inline-block !important; }
    }
    .fixed-bottom-section {
      position: absolute;
      bottom: 15px;
      left: 15px;
      right: 15px;
      background: white;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .signature-box {
      border: 1px dashed #999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 11px;
      color: #666;
      height: 100px;
    }
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .qr-code-placeholder {
      width: 60px;
      height: 60px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 3px;
      background-image: url('https://z-cdn-media.chatglm.cn/files/a5dc47c7-efd9-4c60-b71e-54deaf1386a3.png?auth_key=1866146829-cdad8f344ce548dab0e364a026a54500-0-fad44c61fa3fb30c19388ff26cb5191d');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .qr-code-text {
      font-size: 9px;
      color: #666;
      text-align: center;
    }
    .footer {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 9px;
      color: #666;
      padding: 5px 0;
      border-top: 1px solid #eee;
      margin-top: 5px;
    }
    .contact-info {
      text-align: center;
    }
    .address {
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }
    .contact-details {
      color: #666;
    }
    .controls {
      text-align: center;
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(30, 60, 114, 0.2);
    }
    .btn-secondary {
      background: var(--secondary-color);
    }
    .btn-secondary:hover {
      background: #3a5fb8;
    }
    .btn-add {
      background: var(--success-color);
    }
    .btn-add:hover {
      background: #218838;
    }
    .btn-danger {
      background: var(--danger-color);
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
    }
    .dashboard {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
    }
    .dashboard-content {
      background: white;
      margin: 50px auto;
      width: 90%;
      max-width: 1200px;
      height: 80%;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .dashboard-header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dashboard-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .dashboard-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .invoices-table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoices-table th, .invoices-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: right;
    }
    .invoices-table th {
      background: var(--light-color);
      font-weight: 700;
      color: var(--primary-color);
    }
    .invoice-actions {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    .invoice-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .view-btn {
      background: #007bff;
      color: white;
    }
    .edit-btn {
      background: var(--warning-color);
      color: black;
    }
    .delete-btn {
      background: var(--danger-color);
      color: white;
    }
    .print-btn {
      background: var(--success-color);
      color: white;
    }
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: white;
      }
      .no-print {
        display: none !important;
      }
      .invoice-container {
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 15px;
        box-shadow: none;
        overflow: visible;
      }
      .scrollable-content {
        margin-bottom: 0;
        overflow: visible;
      }
      .invoice-table-container {
        max-height: none;
        overflow: visible;
        border: none;
      }
      .invoice-table th {
        position: static;
      }
      .fixed-bottom-section {
        position: static;
        margin-top: 20px;
      }
      .form-input, .table-input, .form-select {
        border: none;
        background: transparent;
        box-shadow: none;
        outline: none;
      }
      .qr-code-placeholder {
        background-image: url('https://z-cdn-media.chatglm.cn/files/a5dc47c7-efd9-4c60-b71e-54deaf1386a3.png?auth_key=1866146829-cdad8f344ce548dab0e364a026a54500-0-fad44c61fa3fb30c19388ff26cb5191d') !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .print-only {
        display: inline-block !important;
      }
      .form-section {
        margin-bottom: 5px !important;
      }
      .signature-section {
        margin-bottom: 5px !important;
      }
      .footer {
        margin-top: 5px !important;
      }
    }
    @media screen {
      .print-only {
        display: none !important;
      }
    }
    .service-limit-warning {
      background: #fff3cd;
      color: #856404;
      padding: 6px;
      border-radius: 4px;
      margin-bottom: 8px;
      display: none;
      font-size: 11px;
      text-align: center;
    }
    .service-limit-warning.show {
      display: block;
    }
    .compress-rows td {
      padding: 2px 4px !important;
      font-size: 10px !important;
    }
    .compress-rows input.table-input {
      font-size: 11px !important;
      padding: 2px !important;
    }
  </style>
</head>
<body>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
  <div class="controls no-print">
    <button class="btn" onclick="saveInvoice()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <button class="btn btn-secondary" onclick="newInvoice()"><i class="fas fa-plus"></i> ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <button class="btn btn-secondary" onclick="showDashboard()"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
    <button class="btn" onclick="window.print()"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="btn btn-secondary" onclick="exportAsPDF()"><i class="fas fa-file-pdf"></i> Ø­ÙØ¸ PDF</button>
    <button class="btn btn-add" onclick="addService()"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast no-print">
    <span id="toast-icon">âœ“</span>
    <span id="toast-message">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</span>
  </div>

  <!-- ====== Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ====== -->
  <div id="dashboard" class="dashboard">
    <div class="dashboard-content">
      <div class="dashboard-header">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
        <button class="btn btn-danger" onclick="closeDashboard()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="dashboard-body">
        <div class="dashboard-controls">
          <input type="text" class="search-box" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø©..." onkeyup="searchInvoices(this.value)">
          <div>
            <select class="filter-select" id="status-filter" onchange="filterInvoices()">
              <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="paid">Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
              <option value="partial">Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</option>
            </select>
            <select class="filter-select" id="payment-filter" onchange="filterInvoices()">
              <option value="all">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¯ÙØ¹</option>
              <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
              <option value="credit">Ø¢Ø¬Ù„</option>
              <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
              <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ©</option>
              <option value="check">Ø´ÙŠÙƒ Ø¨Ù†ÙƒÙŠ</option>
              <option value="mixed">Ø¬Ø²Ø¦ÙŠ</option>
            </select>
            <select class="filter-select" id="sort-filter" onchange="sortInvoices()">
              <option value="date-desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
              <option value="date-asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
              <option value="total-desc">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„ØºØ§Ù‹</option>
              <option value="total-asc">Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¨Ù„ØºØ§Ù‹</option>
            </select>
          </div>
        </div>
        <table class="invoices-table">
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="invoicesList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ====== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ====== -->
  <div class="invoice-container" id="invoiceForm">
    <!-- Header -->
    <header class="header">
      <div class="company-info">
        <div class="company-name-ar" style="text-align:center;">Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ¬</div>
        <div class="company-subtitle-ar" style="text-align:center;">Ù„Ø£Ù‚Ø§Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶ Ùˆ Ø§Ù„Ù…Ø¤ØªÙ…Ø±Ø§Øª Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©</div>
        <div class="company-name-en" style="text-align:center;">Al Mouj Company For Organizing International Exhibitions and Conferences</div>
      </div>
      <div class="invoice-meta">
        <div class="payment-type cash" id="payment-type">Ù†Ù‚Ø¯ÙŠ</div>
        <div class="invoice-status paid" id="invoice-status">Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</div>
        <div class="invoice-number">Ø±Ù‚Ù…: <span id="invoice-number-display">INV-2024-001</span></div>
      </div>
      <div class="logo-container" style="text-align:center;">
        <img src="https://scontent.fbgw66-3.fna.fbcdn.net/v/t39.30808-6/475480362_460863603763901_8940587884916782522_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=833d8c&_nc_ohc=iMCYWsX0M1cQ7kNvwEToepG&_nc_oc=AdnmPd-_KdA_XgLtQ3CWkEcd9y3MuBHapmRQcLLJsOmBzYjfQfbydSaPmK_OSpAcRgw&_nc_zt=23&_nc_ht=scontent.fbgw66-3.fna&_nc_gid=pZ8dNoh3snM99N41Fczlcg&oh=00_AftVgEaly1QPUEl3fuB-ZGqUKFwIOvNpKi5Gmiv3CNfoLQ&oe=6984EE13" alt="Logo" width="130">
      </div>
    </header>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
    <div class="scrollable-content">
      <!-- Invoice Info -->
      <div class="form-section">
        <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
        <div class="form-grid">
          <div class="form-field">
            <span class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</span>
            <input type="text" class="form-input" id="invoice-number" value="INV-2024-001">
          </div>
          <div class="form-field">
            <span class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
            <input type="date" class="form-input" id="invoice-date">
          </div>
          <div class="form-field">
            <span class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹:</span>
            <select class="form-select" id="payment-type-select" onchange="updatePaymentType()">
              <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
              <option value="credit">Ø¢Ø¬Ù„</option>
              <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
              <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ©</option>
              <option value="check">Ø´ÙŠÙƒ Ø¨Ù†ÙƒÙŠ</option>
              <option value="mixed">Ø¬Ø²Ø¦ÙŠ (Ù†Ù‚Ø¯ÙŠ + Ø¢Ø¬Ù„)</option>
            </select>
          </div>
          <div class="form-field">
            <span class="form-label">Ø§Ù„Ø¹Ù…Ù„Ø©:</span>
            <input type="text" class="form-input" id="currency" value="Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ">
          </div>
        </div>
      </div>

      <!-- Client Info -->
      <div class="form-section">
        <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        <div class="form-grid">
          <div class="form-field">
            <span class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ:</span>
            <input type="text" class="form-input" id="client-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
          </div>
          <div class="form-field">
            <span class="form-label">Ø§Ù„Ù‡Ø§ØªÙ:</span>
            <input type="text" class="form-input" id="client-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
          </div>
          <div class="form-field">
            <span class="form-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</span>
            <input type="text" class="form-input" id="client-province" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
          </div>
          <div class="form-field full-width-field">
            <span class="form-label">Ø§Ù„Ø´Ø±ÙƒØ©:</span>
            <input type="text" class="form-input" id="client-company" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
          </div>
        </div>
      </div>

      <!-- Services -->
      <div class="form-section">
        <div class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
        <div class="service-limit-warning" id="service-limit-warning">
          Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (8 Ø®Ø¯Ù…Ø§Øª) Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹ØªÙ‡ ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©.
        </div>
        <div class="invoice-table-container">
          <table class="invoice-table" id="services-table">
            <thead>
              <tr>
                <th class="col-no">Øª</th>
                <th class="col-details">Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th class="col-price">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th class="no-print"></th>
              </tr>
            </thead>
            <tbody id="products-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Net Amount Section -->
      <div class="net-amount-section">
        <div class="net-amount-label">ØµØ§ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
        <div class="net-amount-value" id="net-amount">0</div>
      </div>

      <!-- Amount in Words Section -->
      <div class="amount-words-section">
        <div class="amount-words-label">Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø©</div>
        <div class="amount-words" id="amount-in-words">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØªØ§Ø¨Ø© Ù‡Ù†Ø§...</div>
      </div>

      <!-- Financial Summary -->
      <div class="form-section" style="margin-bottom: 5px;">
        <div class="section-title">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
        <div class="financial-summary">
          <div class="summary-card">
            <div class="summary-row">
              <span class="summary-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚:</span>
              <input type="number" class="summary-input numeric-input" id="previous-balance-input" value="0" onchange="updateCalculations()">
              <span class="summary-value print-only" id="previous-balance-print">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
              <span class="summary-value" id="current-balance">0</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-row">
              <span class="summary-label">Ø¯ÙØ¹Ø© Ù†Ù‚Ø¯ÙŠØ©:</span>
              <input type="number" class="summary-input numeric-input" id="cash-payment-input" value="0" onchange="updateCalculations()">
              <span class="summary-value print-only" id="cash-payment-print">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø¯ÙØ¹:</span>
              <span class="summary-value" id="remaining-payment">0</span>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /scrollable -->

    <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª -->
    <div class="fixed-bottom-section">
      <!-- Signature & QR Code Section -->
      <div class="form-section" style="margin-bottom: 5px;">
        <div class="section-title">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ±Ù…Ø² Ø§Ù„ØªÙˆØ§ØµÙ„</div>
        <div class="signature-section" style="margin-bottom: 5px;">
          <div class="signature-box"></div>
          <div class="qr-code-container">
            <div class="qr-code-placeholder"></div>
            <div class="qr-code-text">Ø§Ù…Ø³Ø­ Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer" style="margin-top: 5px;">
        <div class="contact-info">
          <div class="address">ÙƒØ±Ø¨Ù„Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø¯Ø³Ø© - Ø§Ù„Ø±ÙˆØ¶ØªÙŠÙ† - Ø§Ù„Ø´Ø§Ø±Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯</div>
          <div class="contact-details">07801068802 | info@almouj.online | almouj.online</div>
        </div>
      </footer>
    </div>
  </div>

  <!-- ================== JavaScript (Ù…ÙØ¯Ù…ÙØ¬) ================== -->
  <script>
    /******************************************************************
     * 1) Ù…ØªØºÙŠØ± Ø¹Ø§Ù… ÙŠØ­Ø¯Ø¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ÙƒØªØ§Ø¨Ø©:
     *    mode = 'local'  â†’ localStorage ÙÙ‚Ø· (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
     *    mode = 'server' â†’ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ù…Ø¬Ù„Ø¯ invoices Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
     ******************************************************************/
    const STORAGE_MODE = 'local';   // ØºÙŠÙ‘Ø±Ù‡ Ø¥Ù„Ù‰ 'server' Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¹Ù†Ø¯Ù…Ø§ ØªØ±ØºØ¨

    /******************************************************************
     * 2) Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Ù„Ø§ ÙŠØªØºÙŠØ±)
     ******************************************************************/
    const STORAGE_KEY = 'almouj_invoices';

    /******************************************************************
     * 3) Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
     *    - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ local â†’ localStorage
     *    - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ server â†’ ØªØ¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª JSON Ù…Ù† Ù…Ø¬Ù„Ø¯ invoices
     ******************************************************************/
    async function loadInvoices() {
      if (STORAGE_MODE === 'server') {
        try {
          // Ù†Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª index)
          // Ø«Ù… Ù†Ø¬Ù„Ø¨ ÙƒÙ„ Ù…Ù„Ù Ø¹Ù„Ù‰ Ø­Ø¯Ø©
          const listRes = await fetch('invoices/');
          if (!listRes.ok) throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø¬Ù„Ø¯ invoices');
          const listText = await listRes.text();
          const fileNames = [...listText.matchAll(/href="(\d+\.json)"/g)].map(m => m[1]);
          const arr = [];
          for (const fname of fileNames) {
            const res = await fetch(`invoices/${fname}`);
            if (res.ok) arr.push(await res.json());
          }
          invoices = arr;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices)); // Ù†Ø²Ø§Ù…Ù†
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
          return;
        } catch (e) {
          console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage');
        }
      }
      // fallback Ø¥Ù„Ù‰ localStorage
      const saved = localStorage.getItem(STORAGE_KEY);
      invoices = saved ? JSON.parse(saved) : [];
    }

    /******************************************************************
     * 4) Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸:
     *    Ø£ÙˆÙ„Ø§Ù‹ localStorageØŒ Ø«Ù… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ù…Ù†ÙØµÙ„ØŒ Ø«Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) PUT
     ******************************************************************/
    async function saveInvoices() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
    }

    async function saveInvoiceToFile(invoice) {
      const blob = new Blob([JSON.stringify(invoice, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${invoice.id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø¯Ø§Ù„Ø© saveToServer() Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ØªÙ…Ù„Ùƒ Ø®Ø§Ø¯Ù…Ø§Ù‹ ÙŠÙ‚Ø¨Ù„ PUT
    async function saveToServer() { return false; }

    /******************************************************************
     * 5) Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„Ùƒ ÙƒÙ…Ø§ Ù‡ÙŠ (sinon) Ù…Ø¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadInvoices() ÙÙŠ
     *    Ø§Ù„Ù€ DOMContentLoaded Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
     ******************************************************************/
    let currentInvoiceId = null;
    let invoices = [];

    window.addEventListener('DOMContentLoaded', async () => {
      await loadInvoices();
      setTodayDate();
      generateNextInvoiceNumber();
      addInitialService();
      document.getElementById('invoice-number').addEventListener('input', e => {
        document.getElementById('invoice-number-display').textContent = e.target.value;
      });
    });

    // ====== Basics ======
    function setTodayDate() {
      document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];
    }
    function generateNextInvoiceNumber() {
      const year = new Date().getFullYear();
      const next = invoices.length + 1;
      const val = `INV-${year}-${String(next).padStart(3, '0')}`;
      document.getElementById('invoice-number').value = val;
      document.getElementById('invoice-number-display').textContent = val;
    }
    function addInitialService() {
      addService();
    }

    // ====== Payment Type ======
    function updatePaymentType() {
      const pt = document.getElementById('payment-type-select').value;
      const el = document.getElementById('payment-type');
      const st = document.getElementById('invoice-status');
      const map = {
        cash: { text: 'Ù†Ù‚Ø¯ÙŠ', cls: 'cash', stext: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', scls: 'paid' },
        credit:{ text: 'Ø¢Ø¬Ù„', cls: 'credit', stext: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©', scls: 'unpaid' },
        bank: { text: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', cls: 'bank', stext: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', scls: 'paid' },
        card: { text: 'Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ©', cls: 'card', stext: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', scls: 'paid' },
        check:{ text: 'Ø´ÙŠÙƒ Ø¨Ù†ÙƒÙŠ', cls: 'check', stext: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', scls: 'paid' },
        mixed:{ text: 'Ø¬Ø²Ø¦ÙŠ (Ù†Ù‚Ø¯ÙŠ + Ø¢Ø¬Ù„)', cls: 'mixed', stext: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹', scls: 'partial' }
      };
      const m = map[pt] || map.cash;
      el.textContent = m.text; el.className = 'payment-type ' + m.cls;
      st.textContent = m.stext; st.className = 'invoice-status ' + m.scls;
      updateCalculations();
    }

    // ====== Services CRUD ======
    function addService(desc = '', amount = 0) {
      const tbody = document.getElementById('products-body');
      if (tbody.children.length >= 8) {
        showToast(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 8 Ø®Ø¯Ù…Ø§Øª Ù„ÙƒÙ„ ØµÙØ­Ø©`, 'warning'); return;
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${tbody.children.length + 1}</td>
        <td class="col-details"><input type="text" class="table-input" value="${desc}" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" oninput="updateCalculations()"></td>
        <td><input type="number" class="table-input numeric-input" value="${amount}" placeholder="0" oninput="updateCalculations()"></td>
        <td class="no-print"><button class="btn btn-danger" style="padding:1px 4px;font-size:10px;" onclick="removeService(this)"><i class="fas fa-trash"></i></button></td>
      `;
      tbody.appendChild(tr);
      if (tbody.children.length >= 5) document.getElementById('services-table').classList.add('compress-rows');
      updateCalculations();
    }
    function removeService(btn) {
      btn.closest('tr').remove();
      renumberServices();
      checkServiceLimit();
      updateCalculations();
    }
    function renumberServices() {
      document.querySelectorAll('#products-body tr').forEach((tr, i) => tr.cells[0].textContent = i + 1);
    }
    function checkServiceLimit() {
      const c = document.getElementById('products-body').children.length;
      document.getElementById('service-limit-warning').classList.toggle('show', c >= 6);
      if (c < 5) document.getElementById('services-table').classList.remove('compress-rows');
    }

    // ====== Calculations ======
    function updateCalculations() {
      let total = 0;
      document.querySelectorAll('#products-body input[type="number"]').forEach(inp => total += (parseFloat(inp.value) || 0));
      const prev = parseFloat(document.getElementById('previous-balance-input').value) || 0;
      const cash = parseFloat(document.getElementById('cash-payment-input').value) || 0;
      const rem  = total - cash;
      const curr = prev + rem;

      document.getElementById('net-amount').textContent = total.toLocaleString();
      document.getElementById('remaining-payment').textContent = rem.toLocaleString();
      document.getElementById('current-balance').textContent = curr.toLocaleString();
      document.getElementById('previous-balance-print').textContent = prev.toLocaleString();
      document.getElementById('cash-payment-print').textContent = cash.toLocaleString();
      document.getElementById('amount-in-words').textContent = convertToArabicWords(total);
    }

    // ====== Arabic Words ======
    function convertToArabicWords(num) {
      if (num === 0) return "ØµÙØ± Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ";
      const ones = ["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©"];
      const teens = ["Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±"];
      const tens = ["","","Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
      const hundreds = ["","Ù…Ø§Ø¦Ø©","Ù…Ø¦ØªØ§Ù†","Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©","Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø®Ù…Ø³Ù…Ø§Ø¦Ø©","Ø³ØªÙ…Ø§Ø¦Ø©","Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©","Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©","ØªØ³Ø¹Ù…Ø§Ø¦Ø©"];
      function convertLessThanThousand(n) {
        if (n === 0) return "";
        let res = "";
        const h = Math.floor(n / 100);
        if (h > 0) res += hundreds[h] + (n % 100 !== 0 ? " Ùˆ" : "");
        n %= 100;
        if (n >= 20) {
          const t = Math.floor(n / 10);
          const o = n % 10;
          res += (o > 0 ? ones[o] + " Ùˆ" : "") + tens[t];
        } else if (n >= 10) {
          res += teens[n - 10];
        } else if (n > 0) {
          res += ones[n];
        }
        return res;
      }
      let parts = [];
      if (num >= 1000000) {
        const m = Math.floor(num / 1000000);
        parts.push(m === 1 ? "Ù…Ù„ÙŠÙˆÙ†" : m === 2 ? "Ù…Ù„ÙŠÙˆÙ†Ø§Ù†" : convertLessThanThousand(m) + " Ù…Ù„ÙŠÙˆÙ†");
        num %= 1000000;
      }
      if (num >= 1000) {
        const th = Math.floor(num / 1000);
        parts.push(th === 1 ? "Ø£Ù„Ù" : th === 2 ? "Ø£Ù„ÙØ§Ù†" : convertLessThanThousand(th) + " Ø£Ù„Ù");
        num %= 1000;
      }
      if (num > 0) parts.push(convertLessThanThousand(num));
      return "ÙÙ‚Ø· " + parts.join(" Ùˆ ") + " Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ Ù„Ø§ ØºÙŠØ±";
    }

    // ====== Collect & Save Invoice ======
    function collectFormData() {
      const services = [];
      document.querySelectorAll('#products-body tr').forEach(tr => {
        const d = tr.cells[1].querySelector('input').value.trim();
        const a = parseFloat(tr.cells[2].querySelector('input').value) || 0;
        if (d) services.push({ description: d, amount: a });
      });
      const prev = parseFloat(document.getElementById('previous-balance-input').value) || 0;
      const cash = parseFloat(document.getElementById('cash-payment-input').value) || 0;
      const total = services.reduce((s, x) => s + x.amount, 0);
      const rem  = total - cash;
      const curr = prev + rem;
      const statusEl = document.getElementById('invoice-status');
      let status = 'paid';
      if (statusEl.classList.contains('partial')) status = 'partial';
      if (statusEl.classList.contains('unpaid')) status = 'unpaid';

      return {
        id: currentInvoiceId || Date.now(),
        invoiceNumber: document.getElementById('invoice-number').value,
        date: document.getElementById('invoice-date').value,
        paymentType: document.getElementById('payment-type-select').value,
        currency: document.getElementById('currency').value,
        clientName: document.getElementById('client-name').value,
        clientPhone: document.getElementById('client-phone').value,
        clientProvince: document.getElementById('client-province').value,
        clientCompany: document.getElementById('client-company').value,
        services, total, previousBalance: prev, cashPayment: cash, remainingPayment: rem, currentBalance: curr, status,
        amountInWords: document.getElementById('amount-in-words').textContent,
        createdAt: new Date().toISOString()
      };
    }
    async function saveInvoice() {
      const data = collectFormData();
      if (!data.clientName || !data.services.length) return showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø§Øª', 'warning');
      const idx = invoices.findIndex(i => i.id === data.id);
      idx === -1 ? invoices.push(data) : invoices[idx] = data;
      await saveInvoices();                       // 1) localStorage
      await saveInvoiceToFile(data);              // 2) ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù
      const serverOk = await saveToServer();      // 3) PUT (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      currentInvoiceId = data.id;
      showToast(serverOk ? 'âœ… Ø­ÙÙØ¸Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…' : 'âœ… Ø­ÙÙØ¸Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù…Ù„Ù Ù…Ù†ÙØµÙ„)');
    }
    function newInvoice() {
      if (!confirm('ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©')) return;
      currentInvoiceId = null;
      document.getElementById('invoiceForm').reset();
      document.getElementById('products-body').innerHTML = '';
      setTodayDate();
      generateNextInvoiceNumber();
      addInitialService();
      updatePaymentType();
      document.getElementById('service-limit-warning').classList.remove('show');
    }

    // ====== Dashboard ======
    function showDashboard() {
      loadInvoicesList();
      document.getElementById('dashboard').style.display = 'block';
    }
    function closeDashboard() {
      document.getElementById('dashboard').style.display = 'none';
    }
    function loadInvoicesList() {
      const tbody = document.getElementById('invoicesList');
      tbody.innerHTML = '';
      [...invoices].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(inv => {
        const payMap = {cash:'Ù†Ù‚Ø¯ÙŠ',credit:'Ø¢Ø¬Ù„',bank:'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',card:'Ø¨Ø·Ø§Ù‚Ø© Ù…ØµØ±ÙÙŠØ©',check:'Ø´ÙŠÙƒ Ø¨Ù†ÙƒÙŠ',mixed:'Ø¬Ø²Ø¦ÙŠ'};
        const statMap = {paid:['Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„','paid'],partial:['Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹','partial'],unpaid:['ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©','unpaid']};
        const [stext, scls] = statMap[inv.status] || ['ØºÙŠØ± Ù…Ø­Ø¯Ø¯',''];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${inv.invoiceNumber}</td>
          <td>${new Date(inv.date).toLocaleDateString('ar-IQ')}</td>
          <td>${inv.clientName}</td>
          <td>${payMap[inv.paymentType] || inv.paymentType}</td>
          <td><span class="invoice-status ${scls}">${stext}</span></td>
          <td>${inv.total.toLocaleString()} ${inv.currency}</td>
          <td>${inv.employeeName || '-'}</td>
          <td>
            <div class="invoice-actions">
              <button class="view-btn" onclick="viewInvoice(${inv.id})" title="Ø¹Ø±Ø¶"><i class="fas fa-eye"></i></button>
              <button class="edit-btn" onclick="editInvoice(${inv.id})" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>
              <button class="delete-btn" onclick="deleteInvoice(${inv.id})" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
              <button class="print-btn" onclick="printInvoiceById(${inv.id})" title="Ø·Ø¨Ø§Ø¹Ø©"><i class="fas fa-print"></i></button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    function searchInvoices(term) {
      const rows = document.querySelectorAll('#invoicesList tr');
      rows.forEach(tr => tr.style.display = tr.textContent.includes(term) ? '' : 'none');
    }
    function filterInvoices() {
      const st = document.getElementById('status-filter').value;
      const pt = document.getElementById('payment-filter').value;
      const rows = document.querySelectorAll('#invoicesList tr');
      rows.forEach(tr => {
        const statusOk = st === 'all' || tr.querySelector('.invoice-status').classList.contains(st);
        const payOk  = pt === 'all' || tr.textContent.includes(pt);
        tr.style.display = (statusOk && payOk) ? '' : 'none';
      });
    }
    function sortInvoices() {
      const v = document.getElementById('sort-filter').value;
      const key = v.split('-')[0]; const desc = v.split('-')[1] === 'desc';
      invoices.sort((a,b) => {
        let x = a[key]; let y = b[key];
        if (key==='date') {x=new Date(x); y=new Date(y);}
        return desc ? (y>x?1:-1) : (x>y?1:-1);
      });
      loadInvoicesList();
    }
    function viewInvoice(id) {
      const inv = invoices.find(i => i.id === id);
      if (inv) {
        loadInvoiceToForm(inv);
        closeDashboard();
      }
    }
    function editInvoice(id) {
      viewInvoice(id);
      currentInvoiceId = id;
    }
    function deleteInvoice(id) {
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
      invoices = invoices.filter(i => i.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      loadInvoicesList();
      showToast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
    }
    function printInvoiceById(id) {
      const inv = invoices.find(i => i.id === id);
      if (inv) {
        loadInvoiceToForm(inv);
        setTimeout(() => window.print(), 300);
      }
    }
    function loadInvoiceToForm(inv) {
      document.getElementById('invoice-number').value = inv.invoiceNumber;
      document.getElementById('invoice-number-display').textContent = inv.invoiceNumber;
      document.getElementById('invoice-date').value = inv.date;
      document.getElementById('payment-type-select').value = inv.paymentType;
      updatePaymentType();
      document.getElementById('currency').value = inv.currency || 'Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ';
      document.getElementById('client-name').value = inv.clientName || '';
      document.getElementById('client-phone').value = inv.clientPhone || '';
      document.getElementById('client-province').value = inv.clientProvince || '';
      document.getElementById('client-company').value = inv.clientCompany || '';
      document.getElementById('previous-balance-input').value = inv.previousBalance || 0;
      document.getElementById('cash-payment-input').value = inv.cashPayment || 0;
      document.getElementById('products-body').innerHTML = '';
      inv.services.forEach(s => addService(s.description, s.amount));
      checkServiceLimit();
      updateCalculations();
    }

    // ====== PDF Export â€“ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø§Ù„Ø­ÙØ¸ ======
    async function exportAsPDF() {
      try {
        showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...');

        // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„Ø© position absolute
        const footer = document.querySelector('.fixed-bottom-section');
        const originalPosition = footer.style.position;
        footer.style.position = 'static';

        const element = document.getElementById('invoiceForm');
        
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: element.offsetWidth,
          height: element.offsetHeight,
          scrollX: 0,
          scrollY: 0
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.98);

        const pdf = new jspdf.jsPDF({
          orientation: 'p',
          unit: 'mm',
          format: 'a4',
          compress: true
        });

        const pageWidth = 210;
        const pageHeight = 297;
        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·ÙˆÙ„ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ù†Ù‚Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // âœ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ
        footer.style.position = originalPosition;

        const fileName = `${document.getElementById('invoice-number').value || 'ÙØ§ØªÙˆØ±Ø©'}.pdf`;
        
        // âœ… Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙƒØ§Ù†)
        if ('showSaveFilePicker' in window) {
          const handle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: [{
              description: 'PDF Documents',
              accept: { 'application/pdf': ['.pdf'] },
            }],
          });
          const writable = await handle.createWritable();
          await pdf.save(writable);
          await writable.close();
          showToast('âœ… ØªÙ… Ø­ÙØ¸ PDF ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ±ØªÙ‡');
        } else {
          // âœ… fallback: ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±
          pdf.save(fileName);
          showToast('âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ PDF Ø¨Ù†Ø¬Ø§Ø­');
        }

      } catch (err) {
        console.error(err);
        showToast('âŒ ÙØ´Ù„ Ø­ÙØ¸ PDF', 'error');
      }
    }

    // ====== Toast Helper ======
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toast-icon');
      const message = document.getElementById('toast-message');
      message.textContent = msg;
      icon.textContent = type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ï¸' : 'âœ—';
      toast.style.background = type === 'success' ? '#1e3c72' : type === 'warning' ? '#f0ad4e' : '#d9534f';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ====== Close Dashboard on Outside Click ======
    document.getElementById('dashboard').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeDashboard();
    });

    // ====== Service Worker Registration ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => console.log('ServiceWorker registered:', registration.scope))
          .catch(error => console.log('ServiceWorker registration failed:', error));
      });
    }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js'); // Ø§Ù„Ù†Ù‚Ø·Ø© ÙˆØ§Ù„Ø´Ø±Ø·Ø© Ù…Ù‡Ù…Ø©
}
  </script>
</body>
</html>
